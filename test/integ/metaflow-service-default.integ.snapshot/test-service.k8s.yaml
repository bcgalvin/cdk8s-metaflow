apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-service-metaflow-service-deployment-c8aea724
  namespace: default
spec:
  minReadySeconds: 0
  progressDeadlineSeconds: 600
  replicas: 1
  selector:
    matchLabels:
      cdk8s.io/metadata.addr: test-service-metaflow-service-deployment-c82eb9b6
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      labels:
        cdk8s.io/metadata.addr: test-service-metaflow-service-deployment-c82eb9b6
    spec:
      automountServiceAccountToken: true
      containers:
        - command:
            - /opt/latest/bin/python3
            - -m
            - services.metadata_service.server
          env:
            - name: MF_METADATA_DB_NAME
              valueFrom:
                configMapKeyRef:
                  key: MF_METADATA_DB_NAME
                  name: container-env
            - name: MF_METADATA_DB_PORT
              valueFrom:
                configMapKeyRef:
                  key: MF_METADATA_DB_PORT
                  name: container-env
            - name: MF_METADATA_DB_PSWD
              valueFrom:
                configMapKeyRef:
                  key: MF_METADATA_DB_PSWD
                  name: container-env
            - name: MF_METADATA_DB_USER
              valueFrom:
                configMapKeyRef:
                  key: MF_METADATA_DB_USER
                  name: container-env
            - name: MF_METADATA_DB_HOST
              valueFrom:
                configMapKeyRef:
                  key: MF_METADATA_DB_HOST
                  name: container-env
          image: public.ecr.aws/outerbounds/metaflow_metadata_service:v2.3.0
          imagePullPolicy: IfNotPresent
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /ping
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 15
          name: metaflow-service
          ports:
            - containerPort: 8080
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /ping
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 15
          securityContext:
            privileged: false
            readOnlyRootFilesystem: false
            runAsNonRoot: false
      dnsPolicy: ClusterFirst
      initContainers:
        - command:
            - /opt/latest/bin/python3
            - /root/run_goose.py
            - --only-if-empty-db
          env:
            - name: MF_METADATA_DB_NAME
              valueFrom:
                configMapKeyRef:
                  key: MF_METADATA_DB_NAME
                  name: init-container-env
            - name: MF_METADATA_DB_PORT
              valueFrom:
                configMapKeyRef:
                  key: MF_METADATA_DB_PORT
                  name: init-container-env
            - name: MF_METADATA_DB_PSWD
              valueFrom:
                configMapKeyRef:
                  key: MF_METADATA_DB_PSWD
                  name: init-container-env
            - name: MF_METADATA_DB_USER
              valueFrom:
                configMapKeyRef:
                  key: MF_METADATA_DB_USER
                  name: init-container-env
            - name: MF_METADATA_DB_HOST
              valueFrom:
                configMapKeyRef:
                  key: MF_METADATA_DB_HOST
                  name: init-container-env
          image: undefined:undefined
          imagePullPolicy: IfNotPresent
          name: init-0
          securityContext:
            privileged: false
            readOnlyRootFilesystem: false
            runAsNonRoot: false
      securityContext:
        fsGroupChangePolicy: Always
        runAsNonRoot: false
      serviceAccountName: base-metaflow-service-sa-c8615416
      setHostnameAsFQDN: false
---
apiVersion: v1
kind: Service
metadata:
  name: test-serv-metaflow-service-deployment-service-c8129362
  namespace: default
spec:
  externalIPs: []
  ports:
    - name: http
      port: 8080
      protocol: TCP
    - name: upgrades
      port: 8082
      protocol: TCP
  selector:
    cdk8s.io/metadata.addr: test-service-metaflow-service-deployment-c82eb9b6
  type: ClusterIP
---
apiVersion: v1
kind: ConfigMap
data:
  MF_METADATA_DB_HOST: release-name-postgresql
  MF_METADATA_DB_NAME: metaflow
  MF_METADATA_DB_PORT: "5432"
  MF_METADATA_DB_PSWD: metaflow
  MF_METADATA_DB_USER: metaflow
immutable: false
metadata:
  name: container-env
  namespace: default
---
apiVersion: v1
kind: ConfigMap
data:
  MF_METADATA_DB_HOST: release-name-postgresql
  MF_METADATA_DB_NAME: metaflow
  MF_METADATA_DB_PORT: "5432"
  MF_METADATA_DB_PSWD: metaflow
  MF_METADATA_DB_USER: metaflow
immutable: false
metadata:
  name: init-container-env
  namespace: default
